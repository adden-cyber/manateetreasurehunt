<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="backend-url" content="/api">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoRo's Treasure Hunt</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body, html {
            margin: 0; padding: 0;
            width: 100vw; height: 100vh;
            overflow: hidden;
        }
        #show-reset {
          color: #0078d7;
          text-decoration: underline;
          cursor: pointer;
        }
        .game-container {
            width: 100vw; height: 100vh;
            min-height: 100vh;
            position: relative;
        }
        .screen {
            width: 100vw; height: 100vh;
            max-width: unset; max-height: unset;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .screen.hidden {
            display: none !important;
        }
        #game-canvas {
            width: 100vw; height: 100vh;
            position: absolute;
            left: 0; top: 0;
            background: #234;
            border-radius: 0;
            box-shadow: none;
            aspect-ratio: unset;
            z-index: 1000;
        }
        /* FIX APPLIED: .game-info style removed from here! Now only in styles.css */
        .score, .treasures, .timer {
            background: #e0e0e0;
            color: #000;
            border-radius: 8px;
            padding: 4px 12px;
            margin: 0 8px;
        }
        #toggle-hud-button {
  position: fixed !important;
  right: 10px !important;
  top: 10px !important;
  z-index: 13000 !important;
  font-size: 0.86em;
  padding: 6px 10px;
  border-radius: 12px;
  background: rgba(255,255,255,0.95);
  color: #08303a;
  box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  border: none;
  pointer-events: auto;
  opacity: 0.98;
}
        .logo {
            margin-bottom: 18px;
            filter: drop-shadow(0 18px 36px rgba(0,0,0,0.45));
            animation: floaty 4.5s ease-in-out infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5em;
        }
        .manatee-icon {
            margin-bottom: 6px;
        }
        .manatee-icon svg {
            display: block;
            width: 70px;
            height: 54px;
            margin: 0 auto;
        }
        @keyframes floaty {
            0%, 100% { transform: translateY(0px);}
            50% { transform: translateY(-6px);}
        }
        @media (max-width: 1200px) {
            .screen { max-width: 100vw; }
            .game-info { font-size: 1em; }
        }
        @media (max-width: 700px) {
            .game-info { font-size: 0.9em; flex-direction: column;}
            .manatee-icon svg { width: 45px; height: 32px; }
            .logo svg { width: 70px; height: 70px; }
            #toggle-hud-button { font-size: 1em; }
        }
        /* Joystick styles */
        /* moved joystick slightly higher and a little inward for better thumb comfort */
        #joystick-container {
            position: fixed;
            left: 20px;
            bottom: calc(env(safe-area-inset-bottom, 16px) + 28px);
            z-index: 1200;
            width: 110px;
            height: 110px;
            pointer-events: auto;
            display: none;
        }
        #joystick-base {
            position: absolute;
            width: 110px; height: 110px;
            border-radius: 50%;
            background: rgba(80,80,80,0.25);
            box-shadow: 0 0 6px #222;
            pointer-events: auto;
        }
        #joystick-stick {
            position: absolute;
            left: 35px; top: 35px;
            width: 40px; height: 40px;
            border-radius: 50%;
            background: rgba(180,180,200,0.8);
            border: 2px solid #77e2ff;
            box-shadow: 0 0 8px #77e2ff;
            pointer-events: auto;
            touch-action: none;
        }

        /* NEW: menu/buttons layout â€” credits above the row of buttons */
        .menu-buttons {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 8px; /* tightened */
          margin-top: 8px; /* moved slightly up */
        }
        .menu-buttons .buttons-row {
          display: flex;
          gap: 14px;
          align-items: center;
          justify-content: center;
          flex-wrap: wrap;
        }
        #user-credits {
          font-weight: 700;
          color: #7fe0ff;
          font-size: 0.98em;
          text-align: center;
        }
        /* improve buttons look/spacing */
        .menu-buttons button {
          padding: 10px 18px;
          border-radius: 18px;
          background: #00f0ea;
          border: none;
          box-shadow: 0 8px 18px rgba(0,240,234,0.12);
          cursor: pointer;
          font-weight: 700;
        }
        .menu-buttons button[disabled] {
          opacity: 0.5;
          cursor: not-allowed;
        }

        /* START: tighter start-screen layout to avoid feeling cramped and push center slightly up */
        #start-screen {
          /* make the start screen a centered 3-column layout */
          display: flex !important;
          flex-direction: row;
          align-items: flex-start;   /* ensure top alignment of columns */
          justify-content: center;
          gap: 22px;
          padding: 18px 28px 12px 28px; /* reduce top padding so center content moves up */
          box-sizing: border-box;
          min-height: calc(100vh - 40px); /* slightly less min-height so inner content is less centered vertically */
        }

        /* left column (history) */
        #user-sessions-container {
          flex: 0 0 260px;         /* fixed-ish narrow column */
          max-width: 260px;
          min-width: 220px;
          margin-top: 6px;
        }

        /* center column (main card) */
        .start-ui {
          flex: 0 0 520px;         /* center card narrower than before */
          max-width: 520px;
          width: 100%;
          background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.08));
          /* smaller top padding and explicit top-alignment so content sits higher */
          padding: 14px 26px 28px 26px;
          border-radius: 18px;
          box-sizing: border-box;

          /* ensure content inside the card is top-aligned so it doesn't center vertically */
          display: flex;
          flex-direction: column;
          justify-content: flex-start;
          align-items: center;
        }

        /* right column (leaderboard) */
        #start-leaderboard-container {
          flex: 0 0 320px;
          max-width: 320px;
          min-width: 260px;
          margin-top: 6px;
        }

        /* scale down headings and central logo */
        .start-ui .logo svg,
        .start-ui .manatee-icon img {
          width: 64px;
          height: auto;
        }
        .start-ui h1 {
          font-size: 34px;          /* reduced from very large */
          line-height: 1.05;
          margin: 6px 0 10px;
          text-shadow: 0 6px 18px rgba(0,160,200,0.22);
        }

        /* welcome and description */
        .start-ui p {
          font-size: 15px;
          margin: 8px 0 12px;
          color: #cfe8f3;
        }

        /* credits and buttons smaller */
        #user-credits { font-size: 0.95em; margin-top: 6px; }
        .menu-buttons button {
          padding: 8px 14px;
          font-size: 0.95em;
          border-radius: 16px;
        }

        /* difficulty controls: make sure they are visible and slightly higher */
        .difficulty-selector {
          margin-top: 10px;
          z-index: 1600;
        }

        /* ensure cost display is visible (not hidden by scripts) and given space */
        #difficulty-cost-display {
          margin-top: 8px;
          display: block;
          color: #ffd95e;
          font-weight: 800;
        }

        /* reduce spacing inside session cards / leaderboard entries */
        #user-sessions-list .session-item,
        #start-leaderboard-container .leaderboard-entry {
          padding: 10px 12px;
          margin-bottom: 10px;
          border-radius: 8px;
        }

        /* make the central welcome line slightly more compact */
        #welcome-user { font-size: 0.95em; margin-bottom: 6px; }

        /* ensure info boxes don't overflow */
        .start-ui, #user-sessions-container, #start-leaderboard-container {
          overflow: visible;
        }

        /* reduce large left/right margins on very wide screens */
        @media (min-width: 1600px) {
          #start-screen { gap: 36px; padding: 24px 36px 18px 36px; }
          .start-ui { flex-basis: 600px; max-width: 600px; padding-top: 12px; }
          #user-sessions-container { flex-basis: 300px; max-width: 300px; }
          #start-leaderboard-container { flex-basis: 360px; max-width: 360px; }
          .start-ui h1 { font-size: 40px; }
        }

        /* revert to vertical stacked layout on small screens */
        @media (max-width: 1000px) {
          #start-screen {
            flex-direction: column;
            padding: 16px;
          }
          #user-sessions-container, #start-leaderboard-container {
            flex: 0 0 auto;
            max-width: 100%;
            width: 100%;
            margin-bottom: 12px;
          }
          .start-ui {
            flex: 0 0 auto;
            max-width: 720px;
            width: 100%;
            padding: 18px;
          }
          .start-ui h1 { font-size: 28px; }
          .menu-buttons button { padding: 10px 14px; }
        }

        /* mobile-only helper: hide by default and show only on small screens */
        .mobile-only { display: none; }
        @media (max-width: 1000px) {
          .mobile-only { display: inline-block; }
        }
        /* END: tighter start-screen layout */

        /* Add / replace these rules in your <style> block */

 /* HUD (top-center pill)
    - Force the HUD to be fixed at top center and above everything else
    - Use inline-flex and auto width so it does NOT stretch full width
    - Adjusted: slightly larger top spacing and much smaller typography & padding
 */
 #game-screen .game-info {
  position: fixed !important;
  top: 48px !important;                 /* moved down so it is under the HUD toggle */
  left: 50% !important;
  transform: translateX(-50%) !important;
  display: inline-flex !important;
  gap: 6px !important;
  align-items: center;
  justify-content: center;
  background: linear-gradient(180deg, rgba(6,30,50,0.95), rgba(6,30,50,0.82));
  padding: 3px 6px !important;          /* reduced padding */
  border-radius: 8px;
  backdrop-filter: blur(6px) saturate(1.05);
  border: 1px solid rgba(255,255,255,0.05);
  box-shadow: 0 6px 14px rgba(0,0,0,0.55);
  z-index: 12000 !important;
  font-size: 0.72rem;                   /* smaller text */
  pointer-events: auto;
  width: auto !important;
  max-width: calc(100% - 100px) !important; /* leave room for the toggle on the right */
}

 /* HUD items (light text on dark pill) */
 #game-screen .game-info .score,
#game-screen .game-info .treasures,
#game-screen .game-info .timer {
  padding: 2px 6px;
  font-weight: 800;
  color: #e6fbff;
  background: transparent;
  box-shadow: none;
  border: none;
  font-size: 0.72em;
}

 /* End game button inside HUD (smaller) */
 #game-screen .game-info #end-game-button {
   margin-left: 6px;
   padding: 4px 8px;
   border-radius: 8px;
   background: linear-gradient(180deg,#00bcd4,#0099c6);
   color: #012;
   border: none;
   font-weight: 800;
   cursor: pointer;
   box-shadow: 0 6px 14px rgba(0,0,0,0.35);
   font-size: 0.82em;
 }

 /* smaller HUD on small screens */
 @media (max-width: 700px) {
   #game-screen .game-info {
     top: 16px !important;
     gap: 6px;
     padding: 4px 6px !important;
     font-size: 0.78rem; /* further reduction on narrow screens */
   }
   #game-screen .game-info .score,
   #game-screen .game-info .treasures,
   #game-screen .game-info .timer {
     font-size: 0.74em;
     padding: 2px 6px;
   }
   #game-screen .game-info #end-game-button { padding: 4px 6px; font-size: 0.78em; }
 }

 /* Play History â€” white card with blue outline (matches leaderboard style screenshot) */
 #user-sessions-container {
   max-height: calc(100vh - 160px);
   overflow: auto;
   padding-right: 6px;
 }

 /* white card with cyan/blue outline */
 #user-sessions-list .session-item {
   background: #ffffff; /* white background */
   border-radius: 12px;
   border: 2px solid #00bcd4; /* cyan/blue outline */
   padding: 12px;
   margin-bottom: 12px;
   color: #023e5f; /* dark-blue text color */
   box-shadow: 0 6px 18px rgba(0,0,0,0.22);
   display: flex;
   flex-direction: column;
   gap: 6px;
 }

 #user-sessions-list .session-item .session-date {
   color: #0078d7; /* vivid blue heading color */
   font-weight: 800;
   font-size: 0.98em;
 }

 #user-sessions-list .session-item .session-difficulty {
   color: #0078d7;
   font-weight: 700;
   margin-top: -2px;
 }

 #user-sessions-list .session-item .session-meta {
   color: #333333; /* neutral dark for meta */
   font-weight: 600;
   font-size: 0.95em;
 }

 /* status chips */
 .session-status.win { color: #118844; font-weight: 900; }
 .session-status.loss { color: #d87f1a; font-weight: 900; }

 /* ensure mobile modal list uses same card visuals */
 #mobile-history-list .session-item {
   background: #ffffff;
   border: 2px solid #00bcd4;
   border-radius: 10px;
   padding: 10px;
   margin-bottom: 10px;
   color: #023e5f;
   box-shadow: 0 6px 12px rgba(0,0,0,0.14);
 }

 /* Small tweaks so mobile modal also looks consistent */
 @media (max-width: 1000px) {
   #user-sessions-container { max-height: none; }
   #user-sessions-list .session-item { margin-bottom: 10px; padding: 10px; border-radius: 12px; }
 }

 /*
  Make start title & logo compact (MINIMIZE)
  - Reduce main heading size and logo so everything fits without zooming
 */
 #start-screen h1 {
   font-size: 18px !important;       /* much smaller */
   margin: 2px 0 6px !important;
   line-height: 1.02;
   letter-spacing: 0.5px;
   text-shadow: 0 6px 12px rgba(0,160,200,0.12) !important;
 }

 .start-ui {
   padding: 10px 14px 14px 14px !important;
   max-width: 420px;
 }

 .start-ui .logo svg,
 .start-ui .manatee-icon img {
   width: 56px !important;  /* smaller logo */
   height: auto !important;
 }

 #welcome-user { font-size: 0.88em !important; margin-bottom: 6px; }

 /* Keep leaderboard and sessions readable while slightly reducing vertical spacing */
 #start-leaderboard-container, .sessions-panel {
   margin-top: 8px !important;
 }

    </style>
</head>
<body>
    <div class="game-container">
        <!-- Add before start-screen -->
<div id="auth-screen" class="screen hidden">
  <div class="auth-form-container">
    <div id="login-form" class="auth-form">
      <div class="logo" aria-hidden="true">
        <div class="manatee-icon">
  <img src="images/my-mascot.png" alt="Mascot" style="width:70px;height:54px;">
</div>
        <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <circle cx="60" cy="60" r="58" fill="#00bcd4" stroke="#fff" stroke-width="4"/>
          <text x="50%" y="53%" text-anchor="middle" fill="#fff" font-size="36" font-family="Arial" dy=".35em">RoRo</text>
        </svg>
      </div>
      <h1 style="margin-bottom: 16px;">RoRo's Treasure Hunt</h1>
      <h2>Login</h2>
      <input id="login-email" type="email" placeholder="Email"><br>
      <input id="login-password" type="password" placeholder="Password"><br>
      <button id="login-btn">Login</button>
      <div class="auth-reset-link">
        <span id="show-reset">Forgot password?</span>
      </div>
      <div class="auth-register-link">
        <span id="show-register">Don't have an account? <b>Register here!</b></span>
      </div>
      <div id="auth-error" style="color:red;"></div>
      <!-- PATCH: reset popups REMOVED from here! -->
    </div>
    <div id="register-form" class="auth-form hidden">
      <h2>Register</h2>
      <input id="register-email" type="email" placeholder="Email"><br>
      <input id="register-password" type="password" placeholder="Password"><br>
      <input id="register-confirm" type="password" placeholder="Confirm Password"><br>
      <button id="register-btn">Register</button>
      <div class="auth-login-link">
        <span id="show-login">Already have an account? <b>Login here!</b></span>
      </div>
      <div id="register-error" style="color:red;"></div>
    </div>
    <div id="register-success-popup" class="auth-popup hidden">
      <h3>You have registered!</h3>
      <p>You can login in the log in page now.</p>
      <p><em>Click anywhere to close.</em></p>
    </div>
    <!-- PATCH: reset popups MOVED HERE -->
    <div id="reset-password-popup" class="auth-popup hidden">
      <h3>Reset Password</h3>
      <input id="reset-email" type="email" placeholder="Enter your email"><br>
      <input id="reset-new-password" type="password" placeholder="New Password"><br>
      <input id="reset-confirm-password" type="password" placeholder="Confirm Password"><br>
      <button id="reset-password-btn">Reset Password</button>
      <button id="reset-return-btn" type="button" style="margin-top:10px;">Return to Login</button>
      <div id="reset-error" style="color:red;"></div>
    </div>
    <div id="reset-success-popup" class="auth-popup hidden">
      <h3>Password reset complete!</h3>
      <p>You can now log in with your new password.</p>
      <p><em>Click anywhere to return to login.</em></p>
    </div>
  </div>
</div>
<!-- STOP PASTING HERE -->
       <div id="start-screen" class="screen hidden" >
        <div id="user-sessions-container" class="sessions-panel" aria-live="polite" style="display: none;">
  <h3>Your Play History</h3>
  <div id="user-sessions-list">
    <div style="color:#666;">Log in to see your sessions</div>
  </div>
</div>
  <div class="start-ui">
  <div class="logo" aria-hidden="true">
                <!-- Manatee icon SVG (above the main logo SVG) -->
                <div class="manatee-icon">
  <img src="images/my-mascot.png" alt="Mascot" style="width:70px;height:54px;">
</div>
                <!-- Main logo SVG -->
                <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="60" cy="60" r="58" fill="#00bcd4" stroke="#fff" stroke-width="4"/>
                    <text x="50%" y="53%" text-anchor="middle" fill="#fff" font-size="36" font-family="Arial" dy=".35em">RoRo</text>
                </svg>
            </div>
            <h1>RoRo's Treasure Hunt</h1>
            <div id="welcome-user" style="font-weight:700;color:#cfefff;margin-bottom:8px;display:none;">
  Welcome, <span id="welcome-email"></span>
</div>
            <p>Help the manatee find treasures underwater!</p>
            <!-- Add this above your Start Game button -->
 <div class="menu-buttons">
  <div id="user-credits" style="margin-bottom:4px;">
    Credits: <span id="credits-value">--</span>
    <div id="credits-msg" style="margin-top:6px;color:#b00;font-weight:600;font-size:0.95em;"></div>
  </div>

  <!-- Start / Logout row: history button now placed here so on mobile it appears inline below credits -->
  <div class="buttons-row">
    <button id="start-button" type="button">Start Game</button>
    <button id="start-logout-btn" type="button">Logout</button>
    <!-- mobile-only history button lives inline with Start + Logout on narrow screens -->
    <button id="mobile-history-btn" class="mobile-only" type="button">History</button>
  </div>

  <div class="buttons-row">
    <button id="send-feedback-btn" type="button">Send Feedback</button>
    <button id="mobile-leaderboard-btn" class="mobile-only" type="button">Leaderboard</button>
  </div>
  </div>

  <div class="difficulty-selector" id="difficulty-selector">
    <button data-value="easy" class="difficulty-btn">Easy</button>
    <button data-value="normal" class="difficulty-btn active">Normal</button>
    <button data-value="hard" class="difficulty-btn">Hard</button>
  </div>

  <div id="difficulty-cost-display" style="margin-top:10px;color:#ffd95e;font-weight:800;display:none;"></div>
</div>
      <div id="start-leaderboard-container" style="flex:1; min-width:320px; margin-left:38px;"></div>
</div>
      
<!-- rest of file unchanged -->
      <div id="game-screen" class="screen hidden">
            <div class="game-info">
                <div class="score">Score: <span id="score-value">0</span></div>
                <div class="treasures">Treasures: <span id="treasures-collected">0</span>/<span id="total-treasures">0</span></div>
                <div class="timer">Time: <span id="timer-value">90</span>s</div>
                <button id="end-game-button" style="margin-left:20px;">End Game</button>
            </div>
            <button id="toggle-hud-button" style="display:none;">Hide HUD</button>
            <canvas id="game-canvas" width="1800" height="1200"></canvas>
        </div>
        
        <div id="completion-popup" class="screen hidden">
            <h2 id="completion-title">Congratulations!</h2>
            <p id="completion-message">You found all the treasures!</p>
            <p>Final Score: <span id="final-score">0</span></p>
            <p>Time Remaining: <span id="time-remaining">0</span>s</p>

            <!-- Credits indicator for completion popup -->
            <div id="credits-remaining-completion" style="margin-top:12px;font-weight:700;color:#cfefff;display:block;">
              You currently have: <span id="credits-remaining-value-completion">--</span>
            </div>
            <div id="credits-warning-completion" style="margin-top:6px;color:#b00;font-weight:800;display:none;">
              Not enough credits, please return to main page.
            </div>

            <button id="completion-play-again-button">Play Again</button>
            <button id="completion-return-to-start-button">Return to Start</button>
        </div>
        
        <div id="quit-result-popup" class="screen hidden">
            <h2 id="quit-title">Game Ended!</h2>
            <p id="quit-message">Your progress before ending:</p>
            <p>Final Score: <span id="quit-final-score">0</span></p>
            <p>Treasures Collected: <span id="quit-treasures-collected">0</span></p>

            <!-- Credits indicator for quit popup -->
            <div id="credits-remaining-quit" style="margin-top:12px;font-weight:700;color:#cfefff;display:block;">
              You currently have: <span id="credits-remaining-value-quit">--</span>
            </div>
            <div id="credits-warning-quit" style="margin-top:6px;color:#b00;font-weight:800;display:none;">
              Not enough credits, please return to main page.
            </div>

            <button id="quit-play-again-button">Play Again</button>
            <button id="quit-return-to-start-button">Return to Start</button>
        </div>

        <div id="feedback-screen" class="screen hidden">
  <h2>Send Feedback</h2>
  <div id="feedback-stars"></div>
  <textarea id="feedback-text" maxlength="1000" placeholder="Tell us about your experience and suggestions..."></textarea>
  <br>
  <button id="feedback-submit-btn">Send Feedback</button>
  <button id="feedback-return-btn" type="button">Return</button>
  <div id="feedback-thankyou" class="hidden">
    Thank you for the feedback! Now click anywhere to return to the start screen.
  </div>
</div>
    <!-- Joystick Overlay for Mobile -->
    <!-- REMOVED inline display:none so JS/CSS can control visibility reliably -->
    <div id="joystick-container" class="mobile-only" aria-hidden="true">
        <div id="joystick-base">
            <div id="joystick-stick"></div>
        </div>
    </div>
<script src="game.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  // Helper to show modal
  function showMobileLeaderboard(diff) {
    document.getElementById('mobile-leaderboard-modal').classList.remove('hidden');
    renderMobileLeaderboard(diff || window.selectedDifficulty || 'normal');
  }
  // Helper to hide modal
  function hideMobileLeaderboard() {
    document.getElementById('mobile-leaderboard-modal').classList.add('hidden');
  }

  // Attach close button event
  document.getElementById('close-mobile-leaderboard').onclick = hideMobileLeaderboard;

  // Attach difficulty selector events
  document.querySelectorAll('#mobile-leaderboard-difficulty .difficulty-btn').forEach(btn => {
    btn.onclick = function() {
      document.querySelectorAll('#mobile-leaderboard-difficulty .difficulty-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      showMobileLeaderboard(btn.getAttribute('data-value'));
    };
  });

  // Attach leaderboard button event
  document.getElementById('mobile-leaderboard-btn').onclick = async function() {
  const btn = document.getElementById('mobile-leaderboard-btn');
  if (!userToken) {
    alert('Please log in to view the leaderboard!');
    return;
  }
  if (!window.lastLeaderboard) {
    try {
      const res = await authFetch(`${backendBase()}/api/leaderboard`, { timeoutMs: 7000, credentials: 'include' });
      if (res.ok) {
        window.lastLeaderboard = await safeParseJson(res) || {};
      } else {
        window.lastLeaderboard = {};
      }
    } catch (e) {
      console.warn('[mobile leaderboard] fetch failed', e);
      window.lastLeaderboard = {};
    }
  }
  showMobileLeaderboard(window.selectedDifficulty || 'normal');
};
  

  // Actual rendering function
  // Replace the existing renderMobileLeaderboard(diff) function with this implementation
function renderMobileLeaderboard(diff) {
  let leaderboard = window.lastLeaderboard || {};
  let entries = leaderboard[diff] || [];
  let listDiv = document.getElementById('mobile-leaderboard-list');
  let title = document.getElementById('mobile-leaderboard-title');
  if (!listDiv || !title) return;
  title.textContent = diff.charAt(0).toUpperCase() + diff.slice(1) + " Leaderboard";

  if (!entries || entries.length === 0) {
    listDiv.innerHTML = `<div style="padding:12px;color:#444;text-align:center;">No winners yet for ${diff}!</div>`;
    return;
  }

  function getCrownSVG(rank) {
    const S = 36;
    const R = S / 2;
    const emojiFontSize = 18;
    if (rank === 0) {
      return `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" style="display:block;">
        <circle cx="${R}" cy="${R}" r="${R}" fill="#FFD700"/><text x="50%" y="58%" text-anchor="middle" font-size="${emojiFontSize}" dy=".35em">ðŸ‘‘</text>
      </svg>`;
    } else if (rank === 1) {
      return `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" style="display:block;">
        <circle cx="${R}" cy="${R}" r="${R}" fill="#C0C0C0"/><text x="50%" y="58%" text-anchor="middle" font-size="${emojiFontSize}" dy=".35em">ðŸ‘‘</text>
      </svg>`;
    } else if (rank === 2) {
      return `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" style="display:block;">
        <circle cx="${R}" cy="${R}" r="${R}" fill="#cd7f32"/><text x="50%" y="58%" text-anchor="middle" font-size="${emojiFontSize}" dy=".35em">ðŸ‘‘</text>
      </svg>`;
    } else {
      return `<span style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:#eee;color:#222;font-weight:700;font-size:14px;">${rank+1}</span>`;
    }
  }

  // Build markup using the same classes the desktop leaderboard uses,
  // so the desktop CSS will style these entries consistently.
  listDiv.innerHTML = entries.map((entry, i) => {
    const icon = getCrownSVG(i);
    const email = (entry && entry.user && entry.user.email) ? entry.user.email : 'unknown';
    const elapsed = (entry && typeof entry.elapsedSeconds !== 'undefined') ? entry.elapsedSeconds : '--';
    const seaweeds = (entry && typeof entry.seaweedsCollected !== 'undefined') ? entry.seaweedsCollected : '--';
    const score = (entry && typeof entry.score !== 'undefined') ? entry.score : '--';

    const metaHtml = `
      <div class="meta" aria-hidden="true">
        <div class="meta-item"><span class="label">Time</span><span class="value">${elapsed} s</span></div>
        <div class="meta-item"><span class="label">Seaweeds</span><span class="value">${seaweeds}</span></div>
        <div class="meta-item"><span class="label">Score</span><span class="value">${score}</span></div>
      </div>
    `;

    return `
      <div class="leaderboard-entry" role="listitem" style="align-items:center;">
        <div class="icon" aria-hidden="true" style="flex:0 0 56px; width:56px; height:56px; display:flex; align-items:center; justify-content:center;">${icon}</div>
        <div class="entry-card" style="flex:1;">
          <div class="info">
            <div class="name" title="${email}">${email}</div>
            ${metaHtml}
          </div>
        </div>
      </div>
    `;
  }).join('');
}
});
</script>

</div>
<!-- Animated bubbles in the background -->
<div class="bubble" style="--x:15vw; --size:48px; --duration:14s;"></div>
<div class="bubble" style="--x:43vw; --size:32px; --duration:12s;"></div>
<div class="bubble" style="--x:66vw; --size:68px; --duration:19s;"></div>
<div class="bubble" style="--x:82vw; --size:40px; --duration:11s;"></div>

 <!-- PATCH for mobile leaderboard modal (copy/paste this block OVER your existing modal markup) -->
<div id="mobile-leaderboard-modal" class="hidden" style="
  position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.75); z-index: 9999; display: flex; 
  align-items: center; justify-content: center; flex-direction: column;">
  <div style="background: #fff; border-radius: 18px; box-shadow: 0 4px 32px #0003; width: 92vw; max-width: 400px; padding: 20px 14px; position: relative; color: #222;">
    <button id="close-mobile-leaderboard" style="position:absolute;top:9px;right:12px;font-size:2em;background:none;border:none;color:#333;z-index:1;">Ã—</button>
    <h2 id="mobile-leaderboard-title" style="text-align:center; color: #222;">Leaderboard</h2>
    <div id="mobile-leaderboard-difficulty" style="margin: 10px 0 14px 0; text-align:center; display:flex; gap:8px; justify-content:center; flex-wrap:nowrap;">
      <button class="difficulty-btn" data-value="easy" style="min-width:0; padding:8px 10px; font-size:0.98em; flex:1 1 0; margin-bottom:0;">Easy</button>
      <button class="difficulty-btn active" data-value="normal" style="min-width:0; padding:8px 10px; font-size:0.98em; flex:1 1 0; margin-bottom:0;">Normal</button>
      <button class="difficulty-btn" data-value="hard" style="min-width:0; padding:8px 10px; font-size:0.98em; flex:1 1 0; margin-bottom:0;">Hard</button>
    </div>
    <div id="mobile-leaderboard-list" style="color: #222;"></div>
  </div>
</div>

  <div id="mobile-history-modal" class="hidden" style="
  position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.75); z-index: 10000; display:flex; align-items:center; justify-content:center;">
  <div style="background:#fff;border-radius:18px;padding:18px; width:92vw; max-width:420px; color:#222; position:relative;">
    <button id="close-mobile-history" style="position:absolute;right:10px;top:8px;border:none;background:none;font-size:1.6em;">Ã—</button>
    <h2 style="text-align:center; margin-top:6px;">Your History</h2>
    <div id="mobile-history-list" style="margin-top:12px; max-height:60vh; overflow:auto; color:#222;">
      <!-- populated by JS -->
    </div>
  </div>
</div>

<!-- End PATCH -->
</body>
</html>