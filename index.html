<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="backend-url" content="/api">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RoRo's Treasure Hunt</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="game-container">
        <!-- Add before start-screen -->
<div id="auth-screen" class="screen hidden">
  <div class="auth-form-container">
    <div id="login-form" class="auth-form">
      <div class="logo" aria-hidden="true">
        <div class="manatee-icon">
  <img src="images/my-mascot.png" alt="Mascot" style="width:70px;height:54px;">
</div>
        <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
          <circle cx="60" cy="60" r="58" fill="#00bcd4" stroke="#fff" stroke-width="4"/>
          <text x="50%" y="53%" text-anchor="middle" fill="#fff" font-size="36" font-family="Arial" dy=".35em">RoRo</text>
        </svg>
      </div>
      <h1 style="margin-bottom: 16px;">RoRo's Treasure Hunt</h1>
      <h2>Login</h2>
      <input id="login-email" type="email" placeholder="Email"><br>
      <input id="login-password" type="password" placeholder="Password"><br>
      <button id="login-btn">Login</button>
      <div class="auth-reset-link">
        <span id="show-reset">Forgot password?</span>
      </div>
      <div class="auth-register-link">
        <span id="show-register">Don't have an account? <b>Register here!</b></span>
      </div>
      <div id="auth-error" style="color:red;"></div>
      <!-- PATCH: reset popups REMOVED from here! -->
    </div>
    <div id="register-form" class="auth-form hidden">
      <h2>Register</h2>
      <input id="register-email" type="email" placeholder="Email"><br>
      <input id="register-password" type="password" placeholder="Password"><br>
      <input id="register-confirm" type="password" placeholder="Confirm Password"><br>
      <button id="register-btn">Register</button>
      <div class="auth-login-link">
        <span id="show-login">Already have an account? <b>Login here!</b></span>
      </div>
      <div id="register-error" style="color:red;"></div>
    </div>
    <div id="register-success-popup" class="auth-popup hidden">
      <h3>You have registered!</h3>
      <p>You can login in the log in page now.</p>
      <p><em>Click anywhere to close.</em></p>
    </div>
    <!-- PATCH: reset popups MOVED HERE -->
    <div id="reset-password-popup" class="auth-popup hidden">
      <h3>Reset Password</h3>
      <input id="reset-email" type="email" placeholder="Enter your email"><br>
      <input id="reset-new-password" type="password" placeholder="New Password"><br>
      <input id="reset-confirm-password" type="password" placeholder="Confirm Password"><br>
      <button id="reset-password-btn">Reset Password</button>
      <button id="reset-return-btn" type="button" style="margin-top:10px;">Return to Login</button>
      <div id="reset-error" style="color:red;"></div>
    </div>
    <div id="reset-success-popup" class="auth-popup hidden">
      <h3>Password reset complete!</h3>
      <p>You can now log in with your new password.</p>
      <p><em>Click anywhere to return to login.</em></p>
    </div>
  </div>
</div>
<!-- STOP PASTING HERE -->
       <div id="start-screen" class="screen hidden" >
        <div id="user-sessions-container" class="sessions-panel" aria-live="polite" style="display: none;">
  <h3>Your Play History</h3>
  <div id="user-sessions-list">
    <div style="color:#666;">Log in to see your sessions</div>
  </div>
</div>
  <div class="start-ui">
  <div class="logo" aria-hidden="true">
                <!-- Manatee icon SVG (above the main logo SVG) -->
                <div class="manatee-icon">
  <img src="images/my-mascot.png" alt="Mascot" style="width:70px;height:54px;">
</div>
                <!-- Main logo SVG -->
                <svg width="120" height="120" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="60" cy="60" r="58" fill="#00bcd4" stroke="#fff" stroke-width="4"/>
                    <text x="50%" y="53%" text-anchor="middle" fill="#fff" font-size="36" font-family="Arial" dy=".35em">RoRo</text>
                </svg>
            </div>
            <h1>RoRo's Treasure Hunt</h1>
            <div id="welcome-user" style="font-weight:700;color:#cfefff;margin-bottom:8px;display:none;">
  Welcome, <span id="welcome-email"></span>
</div>
            <p>Help the manatee find treasures underwater!</p>
            <!-- Add this above your Start Game button -->
            <div class="menu-buttons">
              <div id="user-credits" style="margin-bottom:4px;">
                Credits: <span id="credits-value">--</span>
                <div id="credits-msg" style="margin-top:6px;color:#b00;font-weight:600;font-size:0.95em;"></div>
              </div>
            
              <!-- Start / Logout row (keeps Start + Logout together) -->
              <div class="buttons-row">
                <button id="start-button" type="button">Start Game</button>
                <button id="start-logout-btn" type="button">Logout</button>
              </div>
            
              <!-- Feedback / Leaderboard / History row: all mobile-only buttons inline here -->
              <div class="buttons-row">
                <button id="send-feedback-btn" type="button">Send Feedback</button>
                <button id="mobile-leaderboard-btn" class="mobile-visible" type="button">Leaderboard</button>
                <button id="mobile-history-btn" class="mobile-visible" type="button">History</button>
              </div>
            </div>

  <div class="difficulty-selector" id="difficulty-selector">
    <button data-value="easy" class="difficulty-btn">Easy</button>
    <button data-value="normal" class="difficulty-btn active">Normal</button>
    <button data-value="hard" class="difficulty-btn">Hard</button>
  </div>

  <div id="difficulty-cost-display" style="margin-top:10px;color:#ffd95e;font-weight:800;display:none;"></div>
</div>
      <div id="start-leaderboard-container" style="flex:1; min-width:320px; margin-left:38px;"></div>
</div>
      
<!-- rest of file unchanged -->
      <div id="game-screen" class="screen hidden">
        <div class="game-info" id="desktop-hud">
          <div class="score">Score: <span id="score-value">0</span></div>
          <div class="treasures">Treasures: <span id="treasures-collected">0</span>/<span id="total-treasures">0</span></div>
          <div class="timer">Time: <span id="timer-value">90</span>s</div>
          <button id="end-game-button" style="margin-left:20px;">End Game</button>
        </div>
        
        <!-- MOBILE: separate pills (mobile-only) -->
        <!-- Time pill (top-center) -->
        <div id="mobile-hud-time" class="mobile-only mobile-hud-pill" aria-hidden="true">
          Time: <span id="hud-time-value">90</span>s
        </div>
        
        <!-- Vertical stack under minimap: treasure above score -->
        <div id="mobile-hud-stack" class="mobile-only" aria-hidden="true">
          <div id="mobile-hud-treasures" class="mobile-hud-pill">Treasures: <span id="hud-treasures-value">0</span>/<span id="hud-total-value">0</span></div>
          <div id="mobile-hud-score" class="mobile-hud-pill">Score: <span id="hud-score-value">0</span></div>
        </div>

        <!-- HUD controls container (top-right) - shows the HUD toggle and a mobile End Game button stacked -->
        <div id="hud-controls" style="position:fixed; right:12px; top:12px; z-index:1600; display:flex; flex-direction:column; gap:8px; pointer-events:auto;">
          <button id="toggle-hud-button" style="display:none; pointer-events:auto;">Hide HUD</button>
          <!-- mobile-only end game button (placed under the toggle) -->
          <button id="end-game-button-mobile" class="mobile-only" style="display:none; pointer-events:auto;">End Game</button>
        </div>

        <div id="status-timers" aria-live="polite" aria-atomic="true" class="status-timers" style="display:none; pointer-events:none;">
          <div id="seaweed-timer" class="status-timer status-timer--boost" role="status" aria-hidden="true" style="display:none;">
            <div class="status-label">Boost</div>
            <div class="status-value"><span id="seaweed-time">0s</span></div>
            <div class="status-bar" aria-hidden="true"><div id="seaweed-fill" class="status-bar-fill" style="width:0%"></div></div>
          </div>
        
          <div id="fake-timer" class="status-timer status-timer--slow" role="status" aria-hidden="true" style="display:none;">
            <div class="status-label">Slowed</div>
            <div class="status-value"><span id="fake-time">0s</span></div>
            <div class="status-bar" aria-hidden="true"><div id="fake-fill" class="status-bar-fill" style="width:0%"></div></div>
          </div>
        </div>
        
            <canvas id="game-canvas" width="1800" height="1200"></canvas>
        </div>
        
        
        <div id="completion-popup" class="screen hidden">
            <h2 id="completion-title">Congratulations!</h2>
            <p id="completion-message">You found all the treasures!</p>
            <p>Final Score: <span id="final-score">0</span></p>
            <p>Time Remaining: <span id="time-remaining">0</span>s</p>

            <!-- Credits indicator for completion popup -->
            <div id="credits-remaining-completion" style="margin-top:12px;font-weight:700;color:#cfefff;display:block;">
              You currently have: <span id="credits-remaining-value-completion">--</span>
            </div>
            <div id="credits-warning-completion" style="margin-top:6px;color:#b00;font-weight:800;display:none;">
              Not enough credits, please return to main page.
            </div>

            <button id="completion-play-again-button">Play Again</button>
            <button id="completion-return-to-start-button">Return to Start</button>
        </div>
        
        <div id="quit-result-popup" class="screen hidden">
            <h2 id="quit-title">Game Ended!</h2>
            <p id="quit-message">Your progress before ending:</p>
            <p>Final Score: <span id="quit-final-score">0</span></p>
            <p>Treasures Collected: <span id="quit-treasures-collected">0</span></p>

            <!-- Credits indicator for quit popup -->
            <div id="credits-remaining-quit" style="margin-top:12px;font-weight:700;color:#cfefff;display:block;">
              You currently have: <span id="credits-remaining-value-quit">--</span>
            </div>
            <div id="credits-warning-quit" style="margin-top:6px;color:#b00;font-weight:800;display:none;">
              Not enough credits, please return to main page.
            </div>

            <button id="quit-play-again-button">Play Again</button>
            <button id="quit-return-to-start-button">Return to Start</button>
        </div>

        <div id="feedback-screen" class="screen hidden">
  <h2>Send Feedback</h2>
  <div id="feedback-stars"></div>
  <textarea id="feedback-text" maxlength="1000" placeholder="Tell us about your experience and suggestions..."></textarea>
  <br>
  <button id="feedback-submit-btn">Send Feedback</button>
  <button id="feedback-return-btn" type="button">Return</button>
  <div id="feedback-thankyou" class="hidden">
    Thank you for the feedback! Now click anywhere to return to the start screen.
  </div>
</div>
    <!-- Joystick Overlay for Mobile -->
    <!-- REMOVED inline display:none so JS/CSS can control visibility reliably -->
    <div id="joystick-container" class="mobile-only" aria-hidden="true">
        <div id="joystick-base">
            <div id="joystick-stick"></div>
        </div>
    </div>
<script src="game.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  // Helper to show modal
  function showMobileLeaderboard(diff) {
    document.getElementById('mobile-leaderboard-modal').classList.remove('hidden');
    renderMobileLeaderboard(diff || window.selectedDifficulty || 'normal');
  }
  // Helper to hide modal
  function hideMobileLeaderboard() {
    document.getElementById('mobile-leaderboard-modal').classList.add('hidden');
  }

  // Attach close button event
  const closeMobileLb = document.getElementById('close-mobile-leaderboard');
  if (closeMobileLb) {
    closeMobileLb.addEventListener('click', (ev) => {
      try { hideMobileLeaderboard(); } catch (e) { console.warn('hideMobileLeaderboard failed', e); }
    });
  }

  // Helper: check auth state (works whether isAuthenticated is a global binding or stored on window)
  async function ensureAuthState() {
    try {
      // 1) If a direct global binding exists and is true, we're authenticated.
      if (typeof isAuthenticated !== 'undefined' && isAuthenticated === true) {
        return true;
      }

      // 2) If the global exists but is false, try to refresh using refreshAuth() if provided
      //    (game.js may perform an async refreshAuth on load; calling it allows us to wait)
      if (typeof isAuthenticated !== 'undefined' && isAuthenticated === false) {
        if (typeof window.refreshAuth === 'function') {
          try {
            const refreshed = await window.refreshAuth();
            if (refreshed) return true;
          } catch (e) {
            console.warn('[ensureAuthState] window.refreshAuth failed', e);
          }
        }
        // fallthrough to server check below
      }

      // 3) Try window-scoped flag if present
      if (typeof window.isAuthenticated !== 'undefined' && window.isAuthenticated === true) {
        return true;
      }
      if (typeof window.isAuthenticated !== 'undefined' && window.isAuthenticated === false) {
        // attempt refresh if exposed
        if (typeof window.refreshAuth === 'function') {
          try {
            const refreshed = await window.refreshAuth();
            if (refreshed) return true;
          } catch (e) {
            console.warn('[ensureAuthState] window.refreshAuth failed', e);
          }
        }
      }

      // 4) Final fallback: perform a best-effort server check (/api/me).
      //    Use authFetch if available (it will include cookies); otherwise use fetch.
      if (typeof authFetch === 'function') {
        try {
          const res = await authFetch(`${backendBase()}/api/me`, { timeoutMs: 4000, credentials: 'include' });
          if (res && res.ok) {
            const data = await (res.json().catch(() => ({})));
            return !!(data && data.email);
          }
        } catch (e) {
          console.warn('[ensureAuthState] authFetch /api/me failed', e);
        }
      } else {
        try {
          const res = await fetch(`${backendBase()}/api/me`, { credentials: 'include' });
          if (res && res.ok) {
            const data = await (res.json().catch(() => ({})));
            return !!(data && data.email);
          }
        } catch (e) {
          console.warn('[ensureAuthState] fetch /api/me failed', e);
        }
      }
    } catch (err) {
      console.warn('[ensureAuthState] unexpected error', err);
    }
    return false;
  }

  const mobileLeaderboardBtn = document.getElementById('mobile-leaderboard-btn');
  if (mobileLeaderboardBtn) {
    mobileLeaderboardBtn.addEventListener('click', async function (ev) {
      ev && ev.preventDefault && ev.preventDefault();

      // Resolve auth state reliably
      let auth = false;
      try {
        auth = await ensureAuthState();
      } catch (e) {
        console.warn('[mobileLeaderboard] ensureAuthState failed', e);
        auth = false;
      }

      // If not authenticated, show the auth screen (better UX than a plain alert).
      if (!auth) {
        try {
          const authScreen = document.getElementById('auth-screen');
          if (authScreen && typeof showScreen === 'function') {
            showScreen(authScreen);
          } else {
            alert('Please log in to view the leaderboard!');
          }
        } catch (e) {
          console.warn('show auth screen failed', e);
          alert('Please log in to view the leaderboard!');
        }
        return;
      }

      // Load leaderboard once (best-effort). Keep window.lastLeaderboard as cache.
      if (!window.lastLeaderboard) {
        try {
          if (typeof authFetch === 'function') {
            const res = await authFetch(`${backendBase()}/api/leaderboard`, { timeoutMs: 7000, credentials: 'include' });
            if (res && res.ok) {
              window.lastLeaderboard = await safeParseJson(res) || {};
            } else {
              window.lastLeaderboard = {};
              console.warn('[mobile leaderboard] fetch returned non-ok', res && res.status);
            }
          } else {
            // fallback: fetch without authFetch
            const res = await fetch(`${backendBase()}/api/leaderboard`, { credentials: 'include' });
            if (res && res.ok) {
              window.lastLeaderboard = await res.json().catch(()=>({}));
            } else {
              window.lastLeaderboard = {};
            }
          }
        } catch (e) {
          console.warn('[mobile leaderboard] fetch failed', e);
          window.lastLeaderboard = {};
        }
      }

      // Finally show the modal using the existing helper.
      try {
        showMobileLeaderboard(window.selectedDifficulty || 'normal');
      } catch (e) {
        console.warn('showMobileLeaderboard failed', e);
      }
    });
  }
  

  // Actual rendering function
  // Replace the existing renderMobileLeaderboard(diff) function with this implementation
function renderMobileLeaderboard(diff) {
  let leaderboard = window.lastLeaderboard || {};
  let entries = leaderboard[diff] || [];
  let listDiv = document.getElementById('mobile-leaderboard-list');
  let title = document.getElementById('mobile-leaderboard-title');
  if (!listDiv || !title) return;
  title.textContent = diff.charAt(0).toUpperCase() + diff.slice(1) + " Leaderboard";

  if (!entries || entries.length === 0) {
    listDiv.innerHTML = `<div style="padding:12px;color:#444;text-align:center;">No winners yet for ${diff}!</div>`;
    return;
  }

  function getCrownSVG(rank) {
    const S = 36;
    const R = S / 2;
    const emojiFontSize = 18;
    if (rank === 0) {
      return `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" style="display:block;">
        <circle cx="${R}" cy="${R}" r="${R}" fill="#FFD700"/><text x="50%" y="58%" text-anchor="middle" font-size="${emojiFontSize}" dy=".35em">ðŸ‘‘</text>
      </svg>`;
    } else if (rank === 1) {
      return `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" style="display:block;">
        <circle cx="${R}" cy="${R}" r="${R}" fill="#C0C0C0"/><text x="50%" y="58%" text-anchor="middle" font-size="${emojiFontSize}" dy=".35em">ðŸ‘‘</text>
      </svg>`;
    } else if (rank === 2) {
      return `<svg width="${S}" height="${S}" viewBox="0 0 ${S} ${S}" style="display:block;">
        <circle cx="${R}" cy="${R}" r="${R}" fill="#cd7f32"/><text x="50%" y="58%" text-anchor="middle" font-size="${emojiFontSize}" dy=".35em">ðŸ‘‘</text>
      </svg>`;
    } else {
      return `<span style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:#eee;color:#222;font-weight:700;font-size:14px;">${rank+1}</span>`;
    }
  }

  // Build markup using the same classes the desktop leaderboard uses,
  // so the desktop CSS will style these entries consistently.
  listDiv.innerHTML = entries.map((entry, i) => {
    const icon = getCrownSVG(i);
    const email = (entry && entry.user && entry.user.email) ? entry.user.email : 'unknown';
    const elapsed = (entry && typeof entry.elapsedSeconds !== 'undefined') ? entry.elapsedSeconds : '--';
    const seaweeds = (entry && typeof entry.seaweedsCollected !== 'undefined') ? entry.seaweedsCollected : '--';
    const score = (entry && typeof entry.score !== 'undefined') ? entry.score : '--';

    const metaHtml = `
      <div class="meta" aria-hidden="true">
        <div class="meta-item"><span class="label">Time</span><span class="value">${elapsed} s</span></div>
        <div class="meta-item"><span class="label">Seaweeds</span><span class="value">${seaweeds}</span></div>
        <div class="meta-item"><span class="label">Score</span><span class="value">${score}</span></div>
      </div>
    `;

    return `
      <div class="leaderboard-entry" role="listitem" style="align-items:center;">
        <div class="icon" aria-hidden="true" style="flex:0 0 56px; width:56px; height:56px; display:flex; align-items:center; justify-content:center;">${icon}</div>
        <div class="entry-card" style="flex:1;">
          <div class="info">
            <div class="name" title="${email}">${email}</div>
            ${metaHtml}
          </div>
        </div>
      </div>
    `;
  }).join('');
}
});
</script>

</div>
<!-- Animated bubbles in the background -->
<div class="bubble" style="--x:15vw; --size:48px; --duration:14s;"></div>
<div class="bubble" style="--x:43vw; --size:32px; --duration:12s;"></div>
<div class="bubble" style="--x:66vw; --size:68px; --duration:19s;"></div>
<div class="bubble" style="--x:82vw; --size:40px; --duration:11s;"></div>

 <!-- PATCH for mobile leaderboard modal (copy/paste this block OVER your existing modal markup) -->
<div id="mobile-leaderboard-modal" class="hidden" style="
  position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.75); z-index: 9999; display: flex; 
  align-items: center; justify-content: center; flex-direction: column;">
  <div style="background: #fff; border-radius: 18px; box-shadow: 0 4px 32px #0003; width: 92vw; max-width: 400px; padding: 20px 14px; position: relative; color: #222;">
    <button id="close-mobile-leaderboard" style="position:absolute;top:9px;right:12px;font-size:2em;background:none;border:none;color:#333;z-index:1;">Ã—</button>
    <h2 id="mobile-leaderboard-title" style="text-align:center; color: #222;">Leaderboard</h2>
    <div id="mobile-leaderboard-difficulty" style="margin: 10px 0 14px 0; text-align:center; display:flex; gap:8px; justify-content:center; flex-wrap:nowrap;">
      <button class="difficulty-btn" data-value="easy" style="min-width:0; padding:8px 10px; font-size:0.98em; flex:1 1 0; margin-bottom:0;">Easy</button>
      <button class="difficulty-btn active" data-value="normal" style="min-width:0; padding:8px 10px; font-size:0.98em; flex:1 1 0; margin-bottom:0;">Normal</button>
      <button class="difficulty-btn" data-value="hard" style="min-width:0; padding:8px 10px; font-size:0.98em; flex:1 1 0; margin-bottom:0;">Hard</button>
    </div>
    <div id="mobile-leaderboard-list" style="color: #222;"></div>
  </div>
</div>

  <div id="mobile-history-modal" class="hidden" style="
  position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.75); z-index: 10000; display:flex; align-items:center; justify-content:center;">
  <div style="background:#fff;border-radius:18px;padding:18px; width:92vw; max-width:420px; color:#222; position:relative;">
    <button id="close-mobile-history" style="position:absolute;right:10px;top:8px;border:none;background:none;font-size:1.6em;">Ã—</button>
    <h2 style="text-align:center; margin-top:6px;">Your History</h2>
    <div id="mobile-history-list" style="margin-top:12px; max-height:60vh; overflow:auto; color:#222;">
      <!-- populated by JS -->
    </div>
  </div>
</div>

<!-- Inserted: preferred canvas-based reveal element (transitionCanvas) -->
<canvas id="transitionCanvas" aria-hidden="true" style="display:none;"></canvas>

<div id="reveal-overlay" aria-hidden="true" class="hidden" style="pointer-events:none;"></div>
<!-- End PATCH -->
<script>
  (function() {
    function rand(min, max) { return Math.random() * (max - min) + min; }
  
    function normalizeBubbles() {
      const bubbles = document.querySelectorAll('.bubble');
      bubbles.forEach((b, i) => {
        // Seed sensible CSS variables if they aren't provided inline
        if (!b.style.getPropertyValue('--x')) {
          // distribute across the width
          b.style.setProperty('--x', (10 + i * 22 + rand(-6,6)) + 'vw');
        }
        if (!b.style.getPropertyValue('--size')) {
          b.style.setProperty('--size', (32 + Math.round(rand(0,56))) + 'px');
        }
        if (!b.style.getPropertyValue('--duration')) {
          // randomize duration so the motion is organic
          b.style.setProperty('--duration', (10 + Math.round(rand(0,20))) + 's');
        }
  
        // Force-restart the CSS animation (works around browsers that sometimes don't auto-start)
        b.classList.remove('paused');
        b.style.animation = 'none';
        // a double rAF guarantees the style is applied then the animation is reflowed
        requestAnimationFrame(() => requestAnimationFrame(() => {
          b.style.removeProperty('animation');
        }));
      });
    }
  
    // Pause bubble animations when the tab is hidden to save CPU/battery
    document.addEventListener('visibilitychange', () => {
      const bubbles = document.querySelectorAll('.bubble');
      if (document.hidden) {
        bubbles.forEach(b => b.classList.add('paused'));
      } else {
        bubbles.forEach(b => b.classList.remove('paused'));
        // ensure they restart cleanly
        normalizeBubbles();
      }
    });
  
    // Run once on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', normalizeBubbles, { once: true });
    } else {
      normalizeBubbles();
    }
  })();
  </script>
</body>
</html>